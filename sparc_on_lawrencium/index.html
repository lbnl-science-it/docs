


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="concierge information technology services for science">
      
      
        <link rel="canonical" href="https://lbnl-science-it.github.io/docs/sparc_on_lawrencium/">
      
      
        <meta name="author" content="Shawfeng Dong">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.5">
    
    
      
        <title>SpaRC on Lawrencium - LBNL Science IT Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.df84b5fe.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#running-sparc-on-lawrencium" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://lbnl-science-it.github.io/docs/" title="LBNL Science IT Docs" class="md-header-nav__button md-logo" aria-label="LBNL Science IT Docs">
      
  <img src="../images/7_BL_Vert_547_rgb.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            LBNL Science IT Docs
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              SpaRC on Lawrencium
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/lbnl-science-it/docs-source/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub/lbnl-science-it/docs-source
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://lbnl-science-it.github.io/docs/" title="LBNL Science IT Docs" class="md-nav__button md-logo" aria-label="LBNL Science IT Docs">
      
  <img src="../images/7_BL_Vert_547_rgb.png" alt="logo">

    </a>
    LBNL Science IT Docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lbnl-science-it/docs-source/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub/lbnl-science-it/docs-source
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../consult/" title="Consulting & Training" class="md-nav__link">
      Consulting & Training
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../hpc/" title="High-Performance Computing" class="md-nav__link">
      High-Performance Computing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../data/" title="Data Management & Storage" class="md-nav__link">
      Data Management & Storage
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../support/" title="Science General Support" class="md-nav__link">
      Science General Support
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../compute/" title="Compute Resources" class="md-nav__link">
      Compute Resources
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../storage/" title="Storage Resources" class="md-nav__link">
      Storage Resources
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cloud/" title="Cloud Resources" class="md-nav__link">
      Cloud Resources
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../jeff/" title="Jeff's page" class="md-nav__link">
      Jeff's page
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10" checked>
    
    <label class="md-nav__link" for="nav-10">
      Tutorials
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        SpaRC on Lawrencium
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="SpaRC on Lawrencium" class="md-nav__link md-nav__link--active">
      SpaRC on Lawrencium
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spark-on-demand-on-lawrencium" class="md-nav__link">
    Spark On Demand on Lawrencium
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-sparc" class="md-nav__link">
    Building SpaRC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sparc-interactively" class="md-nav__link">
    Running SpaRC interactively
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sparc-in-batch-mode" class="md-nav__link">
    Running SpaRC in batch mode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues-and-future-improvements" class="md-nav__link">
    Known issues and future improvements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../sparc_on_gcp/" title="SpaRC on GCP" class="md-nav__link">
      SpaRC on GCP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spark-on-demand-on-lawrencium" class="md-nav__link">
    Spark On Demand on Lawrencium
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-sparc" class="md-nav__link">
    Building SpaRC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sparc-interactively" class="md-nav__link">
    Running SpaRC interactively
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sparc-in-batch-mode" class="md-nav__link">
    Running SpaRC in batch mode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues-and-future-improvements" class="md-nav__link">
    Known issues and future improvements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/lbnl-science-it/docs-source/blob/master/docs/sparc_on_lawrencium.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="running-sparc-on-lawrencium">Running SpaRC on Lawrencium</h1>
<p>SpaRC is an <a href="#references">Apache Spark-based scalable genomic sequence clustering application</a>. SpaRC has been running successfully on <a href="https://aws.amazon.com/emr/">AWS EMR</a>, as well as on the <a href="https://www.psc.edu/bridges">Bridges</a> supercomputer at PSC. In this tutorial, I describe how to run SpaRC on <a href="https://sites.google.com/a/lbl.gov/high-performance-computing-services-group/lbnl-supercluster/lawrencium">Lawrencium</a>.</p>
<h2 id="spark-on-demand-on-lawrencium">Spark On Demand on Lawrencium</h2>
<p>Users can run Spark jobs on Lawrencium in <a href="https://sites.google.com/a/lbl.gov/high-performance-computing-services-group/getting-started/faq">Spark On Demand (SOD)</a> fashion, in which a standalone Spark cluster will be created <em>on demand</em> in a Slurm job. Note that the Spark cluster will be running in <a href="https://spark.apache.org/docs/latest/spark-standalone.html">standalone mode</a>, so there will be no YARN cluster manager, nor HDFS. In lieu of HDFS, we'll use Lustre scratch for storage.</p>
<p>As of this writing, there is only Spark <strong>2.1.0</strong> available on Lawrencium. We may install a more up-to-date version in the near future.</p>
<h2 id="building-sparc">Building SpaRC</h2>
<p>You'll build SpaRC against Spark 2.1.0. The source code of SpaRC is hosted on Bitbucket at <a href="https://bitbucket.org/LizhenShi/sparc">https://bitbucket.org/LizhenShi/sparc</a>. I don't have write access to the repo, so I imported it to GitHub, at <a href="https://github.com/shawfdong/sparc">https://github.com/shawfdong/sparc</a>. I've added a new file <code>build.sbt.spark2.1.0</code> to the GitHub repo, which, as the name suggests, will be used to build SpaRC against Spark 2.1.0.</p>
<p>Note that you can't build SpaRC on the login nodes of Lawrencium, because rsync (which is required by sbt) is disabled there. You'll have to use the data transfer node <code>lrc-xfer.lbl.gov</code>:</p>
<pre><code class="shell">$ ssh lrc-xfer.lbl.gov
</code></pre>

<p>Download and unpack the Scala build tool <a href="https://www.scala-sbt.org/">sbt</a>:</p>
<pre><code class="shell">$ wget https://piccolo.link/sbt-1.3.10.tgz
$ tar xvz sbt-1.3.10.tgz
</code></pre>

<p>Load the module for JDK 1.8.0:</p>
<pre><code class="shell">$ export MODULEPATH=$MODULEPATH:/global/software/sl-7.x86_64/modfiles/langs
$ module load java
$ java -version
java version &quot;1.8.0_121&quot;
Java(TM) SE Runtime Environment (build 1.8.0_121-b13)
Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)
</code></pre>

<p>Clone and build SpaRC:</p>
<pre><code class="shell">$ git clone https://github.com/shawfdong/sparc.git
$ cd sparc
$ cp build.sbt.spark2.1.0 build.sbt
$ ~/sbt/bin/sbt assembly
</code></pre>

<p>This will create a fat jar file <code>~/sparc/target/scala-2.11/LocalCluster-assembly-0.2.jar</code>. Copy it to your Lustre scratch space:</p>
<pre><code>$ cp target/scala-2.11/LocalCluster-assembly-0.2.jar /global/scratch/$USER/
</code></pre>

<p>While you are at it, also download a sample sequence data file:</p>
<pre><code class="console">$ cd /global/scratch/$USER
$ curl http://s3.amazonaws.com/share.jgi-ga.org/sparc_example/illumina_02G_merged_with_id.seq.gz -o sample.seq.gz
$ gunzip sample.seq.gz
$ wc -l sample.seq
6343345 sample.seq
$ head -2 sample.seq
6   HISEQ13:204:C8T6VANXX:1:1101:3726:1992  NATATTCCCGTTCTGATATTGCGTTAAGTCGTTCCCCTAAGCCGGCCCTCCTTATCGAGCGCGCCGGCTTTTTTTGCCATGTTCAGCGAATCACAGGACAAGATACTTCACCTAACGTAGTAGATGGTTCTATGCTTAAGGGCAAGGTGTNTTAATCTCGATATCCGCCTGTTTTAATAAATCAGCGACGAAGCGATGGGAGGATAAGCGCTCGTCAAAAACCACGCGCTTTTTTTCTAAGGTGGGTAAGTTCAAGGTAACACCCCCACTATGCCTATGAGTGAATTGGTAACACCTTGCC
60  HISEQ13:204:C8T6VANXX:1:1101:4370:1919  NCGTGCGCCCATCTCCGTGGCTAAACAGCTTGAGGTGGAAATTCGCCAGTGGATACAGCAGCATGCAGCGACAGGCGGGCGTCGCCTCCCTTCGATACGCCATTTAGCAGCAACACATAACGTCAGCCGCAATGCAGTCATTGAAGCTTANGTAAGGTCTTCTCCTTCGCGCCAATCGTTAGGTAACCAGCCGCAGCCCAGTTTCAATGACTGTTCATCGGTGTTAAACACGCCCCATAAGCCATTCGTCACTTCTTCCAATGGCGTTGATGACGCGGGTTGAACCAGTTTCAGCGCGTTA
</code></pre>

<p>Now you can exit from <code>lrc-xfer.lbl.gov</code>.</p>
<p><em>Alternatively</em>, you could build SpaRC on your local computer, then upload the assembled fat jar file to your Lustre scratch space on Lawrencium.</p>
<h2 id="running-sparc-interactively">Running SpaRC interactively</h2>
<p>SSH to a Lawrencium login node:</p>
<pre><code class="shell">$ ssh lrc-login.lbl.gov
</code></pre>

<p>For demonstration purpose, request 2 nodes from the <a href="https://sites.google.com/a/lbl.gov/high-performance-computing-services-group/lbnl-supercluster/lawrencium">lr6 partition</a> for the interactive job:</p>
<pre><code>$ cd /global/scratch/$USER
$ srun -p lr6 --qos=lr_normal -N 2 -t 1:00:0 --account=&lt;NAME_OF_YOUR_PROJECT_ACCOUNT&gt; --pty bash
</code></pre>

<p>When the job starts, you'll be given exclusive allocation to 2 compute nodes in the lr6 partition, each one of which has 2x 16-core Intel Xeon Gold 6130 CPUs and 96 GB memory (so in total, there will be 64 cores and 192GB memory available in your Spark cluster). And you'll be dropped to a <code>bash</code> shell on one of the compute nodes. Start Spark On Demand (SOD):</p>
<pre><code>$ source /global/home/groups/allhands/bin/spark_helper.sh
$ spark-start
</code></pre>

<p>Run the first Spark job on SOD (you might want to tune the values for <code>--executor-cores</code>, <code>--num-executors</code> and <code>--executor-memory</code>):</p>
<pre><code>$ SCRATCH=/global/scratch/$USER
$ JAR=$SCRATCH/LocalCluster-assembly-0.2.jar
$ OPT1=&quot;--master $SPARK_URL --executor-cores 4 --num-executors 16 --executor-memory 12g&quot;
$ OPT2=&quot;--conf spark.executor.extraClassPath=$JAR \
    --conf spark.driver.maxResultSize=8g \
    --conf spark.network.timeout=360000 \
    --conf spark.speculation=true \
    --conf spark.default.parallelism=100 \
    --conf spark.eventLog.enabled=false&quot;
$ spark-submit $OPT1 $OPT2 \
    $JAR KmerCounting --wait 1 \
    -i $SCRATCH/sample.seq \
    -o $SCRATCH/test_kc_seq_31 --format seq -k 31 -C
</code></pre>

<p>Run the second Spark job:</p>
<pre><code>$ spark-submit $OPT1 $OPT2 \
    $JAR KmerMapReads2 --wait 1 \
    --reads $SCRATCH/sample.seq \
    --format seq -o $SCRATCH/test_kmerreads.txt_31 -k 31 \
    --kmer $SCRATCH/test_kc_seq_31 \
    --contamination 0 --min_kmer_count 2 \
    --max_kmer_count 100000 -C --n_iteration 1
</code></pre>

<p>Run the third Spark job:</p>
<pre><code>$ spark-submit $OPT1 $OPT2 \
    $JAR GraphGen2 --wait 1 \
    -i $SCRATCH/test_kmerreads.txt_31 \
    -o $SCRATCH/test_edges.txt_31 \
    --min_shared_kmers 2 --max_degree 50 -n 1000
</code></pre>

<p>Run the fourth Spark job:</p>
<pre><code>$ spark-submit $OPT1 $OPT2 \
    $JAR GraphLPA2 --wait 1 \
    -i $SCRATCH/test_edges.txt_31 \
    -o $SCRATCH/test_lpa.txt_31 \
    --min_shared_kmers 2 --max_shared_kmers 20000 \
    --min_reads_per_cluster 2 --max_iteration 10 -n 1000
</code></pre>

<p>Run the fifth Spark job:</p>
<pre><code>$ spark-submit $OPT1 $OPT2 \
    $JAR CCAddSeq --wait 1 \
    -i $SCRATCH/test_lpa.txt_31 \
    --reads $SCRATCH/sample.seq \
    -o $SCRATCH/sample_lpaseq.txt_31
</code></pre>

<p>Once you are done, don't forget to stop Spark On Demand and exit from the interactive job: </p>
<pre><code>$ spark-stop
$ exit
</code></pre>

<h2 id="running-sparc-in-batch-mode">Running SpaRC in batch mode</h2>
<p>To run SpaRC in batch mode, write a Slurm job script and call it <code>sparc.slurm</code>:</p>
<pre><code class="bash">#!/bin/bash
#SBATCH --job-name=sparc
#SBATCH --partition=lr6
#SBATCH --qos=lr_normal
#SBATCH --account=&lt;NAME_OF_YOUR_PROJECT_ACCOUNT&gt;
#SBATCH --nodes=2
#SBATCH --time=01:00:00

source /global/home/groups/allhands/bin/spark_helper.sh
# Start Spark On Demand
spark-start

SCRATCH=/global/scratch/$USER
JAR=$SCRATCH/LocalCluster-assembly-0.2.jar
OPT1=&quot;--master $SPARK_URL --executor-cores 4 --num-executors 16 --executor-memory 12g&quot;
OPT2=&quot;--conf spark.executor.extraClassPath=$JAR \
    --conf spark.driver.maxResultSize=8g \
    --conf spark.network.timeout=360000 \
    --conf spark.speculation=true \
    --conf spark.default.parallelism=100 \
    --conf spark.eventLog.enabled=false&quot;

# 1st Spark job
spark-submit $OPT1 $OPT2 \
    $JAR KmerCounting --wait 1 \
    -i $SCRATCH/sample.seq \
    -o $SCRATCH/test_kc_seq_31 --format seq -k 31 -C

# 2nd Spark job
spark-submit $OPT1 $OPT2 \
    $JAR KmerMapReads2 --wait 1 \
    --reads $SCRATCH/sample.seq \
    --format seq -o $SCRATCH/test_kmerreads.txt_31 -k 31 \
    --kmer $SCRATCH/test_kc_seq_31 \
    --contamination 0 --min_kmer_count 2 \
    --max_kmer_count 100000 -C --n_iteration 1

# 3rd Spark job
spark-submit $OPT1 $OPT2 \
    $JAR GraphGen2 --wait 1 \
    -i $SCRATCH/test_kmerreads.txt_31 \
    -o $SCRATCH/test_edges.txt_31 \
    --min_shared_kmers 2 --max_degree 50 -n 1000
Run the fourth Spark job:

# 4th Spark job
spark-submit $OPT1 $OPT2 \
    $JAR GraphLPA2 --wait 1 \
    -i $SCRATCH/test_edges.txt_31 \
    -o $SCRATCH/test_lpa.txt_31 \
    --min_shared_kmers 2 --max_shared_kmers 20000 \
    --min_reads_per_cluster 2 --max_iteration 10 -n 1000

# 5th Spark job
spark-submit $OPT1 $OPT2 \
    $JAR CCAddSeq --wait 1 \
    -i $SCRATCH/test_lpa.txt_31 \
    --reads $SCRATCH/sample.seq \
    -o $SCRATCH/sample_lpaseq.txt_31

# Stop Spark On Demand
spark-stop
</code></pre>

<p>Then submit the job with:</p>
<pre><code class="shell">sbatch sparc.slurm
</code></pre>

<h2 id="known-issues-and-future-improvements">Known issues and future improvements</h2>
<ol>
<li>Presumably, there is a switch <code>-i</code> to <code>spark-start</code> that would enable communications over the IPoIB network. But it doesn't work!</li>
<li>Spark 2.1.0 is a bit old.</li>
</ol>
<h2 id="references">References</h2>
<ol>
<li><a href="https://academic.oup.com/bioinformatics/article/35/5/760/5078476">https://academic.oup.com/bioinformatics/article/35/5/760/5078476</a></li>
<li><a href="https://peerj.com/articles/8966/">https://peerj.com/articles/8966/</a></li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../jeff/" title="Jeff's page" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Jeff's page
              </div>
            </div>
          </a>
        
        
          <a href="../sparc_on_gcp/" title="SpaRC on GCP" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                SpaRC on GCP
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; LBNL 2020 Science IT Consultants
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.83fe6e3c.min.js"></script>
      <script src="../assets/javascripts/bundle.7e1cb91c.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>